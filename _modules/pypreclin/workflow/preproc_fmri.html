<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
  
    <title>PYPRECLIN &mdash; pypreclin</title>
  <!-- htmltitle is before nature.css - we use this hack to load bootstrap first -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../../../_static/css/bootstrap.min.css" media="screen" />

    
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="pypreclin" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
  
   
       <script type="text/javascript" src="../../../_static/sidebar.js"></script>
   
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="../../../_static/js/bootstrap.min.js" type="text/javascript"></script>

  <script src="../../../_static/js/angular.min.js" type="text/javascript"></script>
  <script type="text/javascript">
    var app = angular.module("navApp", []);
    app.controller('navCtrl', ['$scope', '$window', function($scope, $window) {
      $scope.isActive = function (viewLocation) {
        var rel = $window.location.pathname.split("/")
        rel = rel[rel.length - 1]
        rel = rel.split(".")[0]
        var active = (viewLocation === rel);
        return active;};
    }]);
  </script>

  </head>
  <body role="document"><div class="banner">
  <div class="container-fluid banner-container">
    <div class="row banner-inner">
      <div class="col-xs-4">
        <img alt="Logo" src="../../../_static/pypreclin.png">
      </div>
      <div class="col-xs-8">
            <p>Python processing for PreClinical data.</p>
      </div>
    </div>  
  </div>
</div><nav class="navbar navbar-default navbar-static-top">
  <div class="container-fluid">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
        </a>
    </div>
    <div id="navbar" class="navbar-collapse collapse" ng-controller="navCtrl" ng-app="navApp">
      <ul class="nav navbar-nav">
        <li ng-class="{ active: isActive('index') }"><a href="../../../index.html">Home</a></li>
        <li ng-class="{ active: isActive('installation') }"><a href="../../../generated/installation.html">Installation</a></li>
        <li ng-class="{ active: isActive('gallery') }"><a href="../../../auto_gallery/gallery.html">Gallery</a></li>
        <li ng-class="{ active: isActive('documentation') }"><a href="../../../generated/documentation.html">API documentation</a></li>
        <!--<li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> <span class="caret"></span></a>
          <ul class="dropdown-menu">
	        <li><a href="../../../generated/pypreclin.html">Pypreclin</a></li>
<li><a href="../../../generated/pypreclin.utils.html">Pypreclin.utils</a></li>
<li><a href="../../../generated/pypreclin.apps.html">Pypreclin.apps</a></li>
<li><a href="../../../generated/pypreclin.plotting.html">Pypreclin.plotting</a></li>
<li><a href="../../../generated/pypreclin.workflow.html">Pypreclin.workflow</a></li>
<li><a href="../../../generated/pypreclin.preproc.html">Pypreclin.preproc</a></li>
          </ul>
        </li>-->
        <li><a href="http://www.unicog.org/site_2016/">UNICOG</a></li>
      </ul>
    </div>
  </div>
</nav>
<div class="content-wrapper">
    <div class="sphinxsidebar">
      <div class="sphinxsidebarwrapper">

        <!-- info setup -->
          <p class="doc-version">
           This documentation is for pypreclin <strong>version 1.0.0</strong>
          </p>
        <p class="citing">
          If you use the software, please do not hesitate to 
          <a &mdash; <a href="https://github.com/neurospin/pypreclin">
          Report a Bug</a>.
        </p>

      <!-- toc tree -->
      

      </div>
    </div>
  

  <div class="content">
      
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pypreclin.workflow.preproc_fmri</h1><div class="highlight"><pre>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">##########################################################################</span>
<span class="c1"># NSAp - Copyright (C) CEA, 2019</span>
<span class="c1"># Distributed under the terms of the CeCILL-B license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL-B_V1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">fMRI preprocessings using FSL, SPM, JIP, and ANTS.</span>

<span class="sd">Steps</span>
<span class="sd">-----</span>

<span class="sd">1. Slice Timing correction (with cache).</span>
<span class="sd">2. B0 inhomogeneties correction (optional, with cache).</span>
<span class="sd">3. Reorient images not in RAS coordinate system and reorient images to match</span>
<span class="sd">   the orientation of the standard MNI152 template (with cache).</span>
<span class="sd">4. Realign: motion correction - adjust for movement between slices (with</span>
<span class="sd">   cache).</span>
<span class="sd">5. Normalization: warp images to fit to a standard template brain (with cache).</span>
<span class="sd">6. Tissues segmentation and spatial intensity variations correction (with</span>
<span class="sd">   cache).</span>
<span class="sd">7. Coregistration: overlay structural and functional images - link</span>
<span class="sd">   functional scans to anatomical scan (with cache).</span>
<span class="sd">8. Wrap functional: resample the functional serie and mask the registered</span>
<span class="sd">   serie (with cache).</span>
<span class="sd">9. Smooth the functional time serie (with cache).</span>
<span class="sd">10. SNAPs: compute some snaps assessing the different processing steps (with</span>
<span class="sd">    cache).</span>
<span class="sd">11. Reporting: generate a QC reporting (with cache).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># System import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># Module import</span>
<span class="kn">import</span> <span class="nn">pypreclin</span>
<span class="kn">from</span> <span class="nn">pypreclin</span> <span class="kn">import</span> <span class="n">DEFAULT_FSL_PATH</span>
<span class="kn">from</span> <span class="nn">pypreclin.utils.reorient</span> <span class="kn">import</span> <span class="n">reorient_image</span>
<span class="kn">from</span> <span class="nn">pypreclin.utils.reorient</span> <span class="kn">import</span> <span class="n">guess_orientation</span>
<span class="kn">from</span> <span class="nn">pypreclin.preproc.register</span> <span class="kn">import</span> <span class="n">check_jip_install</span>
<span class="kn">from</span> <span class="nn">pypreclin.preproc.register</span> <span class="kn">import</span> <span class="n">jip_align</span>
<span class="kn">from</span> <span class="nn">pypreclin.preproc.register</span> <span class="kn">import</span> <span class="n">apply_jip_align</span>
<span class="kn">from</span> <span class="nn">pypreclin.preproc.register</span> <span class="kn">import</span> <span class="n">timeserie_to_reference</span>
<span class="kn">from</span> <span class="nn">pypreclin.preproc.register</span> <span class="kn">import</span> <span class="n">resample_image</span>
<span class="kn">from</span> <span class="nn">pypreclin.preproc.undist</span> <span class="kn">import</span> <span class="n">topup</span>
<span class="kn">from</span> <span class="nn">pypreclin.preproc.undist</span> <span class="kn">import</span> <span class="n">fugue</span>
<span class="kn">from</span> <span class="nn">pypreclin.plotting.check_preprocessing</span> <span class="kn">import</span> <span class="n">plot_fsl_motion_parameters</span>

<span class="c1"># PyConnectome import</span>
<span class="kn">from</span> <span class="nn">pyconnectome.configuration</span> <span class="kn">import</span> <span class="n">environment</span><span class="p">,</span> <span class="n">concat_environment</span>
<span class="kn">from</span> <span class="nn">pyconnectome.utils.filetools</span> <span class="kn">import</span> <span class="n">fslreorient2std</span>
<span class="kn">from</span> <span class="nn">pyconnectome.utils.filetools</span> <span class="kn">import</span> <span class="n">apply_mask</span>
<span class="kn">from</span> <span class="nn">pyconnectome.utils.segtools</span> <span class="kn">import</span> <span class="n">fast</span>
<span class="kn">from</span> <span class="nn">pyconnectome.utils.segtools</span> <span class="kn">import</span> <span class="n">bet2</span>
<span class="kn">from</span> <span class="nn">pyconnectome.utils.regtools</span> <span class="kn">import</span> <span class="n">mcflirt</span>
<span class="kn">from</span> <span class="nn">pyconnectome.utils.regtools</span> <span class="kn">import</span> <span class="n">flirt</span>
<span class="kn">from</span> <span class="nn">pyconnectome.plotting.slicer</span> <span class="kn">import</span> <span class="n">triplanar</span>

<span class="c1"># PyConnectomist import</span>
<span class="kn">from</span> <span class="nn">pyconnectomist.utils.pdftools</span> <span class="kn">import</span> <span class="n">generate_pdf</span>

<span class="c1"># Third party import</span>
<span class="kn">import</span> <span class="nn">nibabel</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">hopla.converter</span> <span class="kn">import</span> <span class="n">hopla</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Memory</span> <span class="k">as</span> <span class="n">JoblibMemory</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">fsl</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">ants</span>
<span class="kn">from</span> <span class="nn">nipype.caching</span> <span class="kn">import</span> <span class="n">Memory</span> <span class="k">as</span> <span class="n">NipypeMemory</span>


<span class="c1"># Global parameters</span>
<span class="n">STEPS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;slice_timing&quot;</span><span class="p">:</span> <span class="s2">&quot;1-SliceTiming&quot;</span><span class="p">,</span>
    <span class="s2">&quot;warp&quot;</span><span class="p">:</span> <span class="s2">&quot;2-B0Inhomogeneities&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reorient&quot;</span><span class="p">:</span> <span class="s2">&quot;3-Reorient&quot;</span><span class="p">,</span>
    <span class="s2">&quot;realign&quot;</span><span class="p">:</span> <span class="s2">&quot;4-Realign&quot;</span><span class="p">,</span>
    <span class="s2">&quot;normalization&quot;</span><span class="p">:</span> <span class="s2">&quot;5-Normalization&quot;</span><span class="p">,</span>
    <span class="s2">&quot;inhomogeneities&quot;</span><span class="p">:</span> <span class="s2">&quot;6-Inhomogeneities&quot;</span><span class="p">,</span>
    <span class="s2">&quot;coregistration&quot;</span><span class="p">:</span> <span class="s2">&quot;7-Coregistration&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wrap&quot;</span><span class="p">:</span> <span class="s2">&quot;8-Wrap&quot;</span><span class="p">,</span>
    <span class="s2">&quot;smooth&quot;</span><span class="p">:</span> <span class="s2">&quot;9-Smooth&quot;</span><span class="p">,</span>
    <span class="s2">&quot;snaps&quot;</span><span class="p">:</span> <span class="s2">&quot;10-Snaps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="s2">&quot;11-Report&quot;</span>
<span class="p">}</span>


<div class="viewcode-block" id="preproc"><a class="viewcode-back" href="../../../generated/pypreclin.workflow.preproc_fmri.html#pypreclin.workflow.preproc_fmri.preproc">[docs]</a><span class="k">def</span> <span class="nf">preproc</span><span class="p">(</span>
        <span class="n">funcfile</span><span class="p">,</span>
        <span class="n">anatfile</span><span class="p">,</span>
        <span class="n">sid</span><span class="p">,</span>
        <span class="n">outdir</span><span class="p">,</span>
        <span class="n">repetitiontime</span><span class="p">,</span>
        <span class="n">template</span><span class="p">,</span>
        <span class="n">jipdir</span><span class="p">,</span>
        <span class="n">erase</span><span class="p">,</span>
        <span class="n">resample</span><span class="p">,</span>
        <span class="n">interleaved</span><span class="p">,</span>
        <span class="n">sliceorder</span><span class="p">,</span>
        <span class="n">realign_dof</span><span class="p">,</span>
        <span class="n">realign_to_vol</span><span class="p">,</span>
        <span class="n">warp</span><span class="p">,</span>
        <span class="n">warp_njobs</span><span class="p">,</span>
        <span class="n">warp_index</span><span class="p">,</span>
        <span class="n">warp_file</span><span class="p">,</span>
        <span class="n">warp_restrict</span><span class="p">,</span>
        <span class="n">delta_te</span><span class="p">,</span>
        <span class="n">dwell_time</span><span class="p">,</span>
        <span class="n">manufacturer</span><span class="p">,</span>
        <span class="n">blip_files</span><span class="p">,</span>
        <span class="n">blip_enc_dirs</span><span class="p">,</span>
        <span class="n">unwarp_direction</span><span class="p">,</span>
        <span class="n">phase_file</span><span class="p">,</span>
        <span class="n">magnitude_file</span><span class="p">,</span>
        <span class="n">anatorient</span><span class="p">,</span>
        <span class="n">funcorient</span><span class="p">,</span>
        <span class="n">kernel_size</span><span class="p">,</span>
        <span class="n">fslconfig</span><span class="p">,</span>
        <span class="n">normalization_trf</span><span class="p">,</span>
        <span class="n">coregistration_trf</span><span class="p">,</span>
        <span class="n">recon1</span><span class="p">,</span>
        <span class="n">recon2</span><span class="p">,</span>
        <span class="n">auto</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; fMRI preprocessings using FSL, SPM, JIP, and ANTS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: remove when all controls available in pypipe</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">erase</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">erase</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">erase</span><span class="p">)</span>
        <span class="n">resample</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">resample</span><span class="p">)</span>
        <span class="n">interleaved</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">interleaved</span><span class="p">)</span>
        <span class="n">realign_to_vol</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">realign_to_vol</span><span class="p">)</span>
        <span class="n">warp</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">warp</span><span class="p">)</span>
        <span class="n">recon1</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">recon1</span><span class="p">)</span>
        <span class="n">recon2</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">recon2</span><span class="p">)</span>
        <span class="n">auto</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">auto</span><span class="p">)</span>
        <span class="n">warp_restrict</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">warp_restrict</span><span class="p">)</span>
        <span class="n">blip_files</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">blip_files</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="nb">eval</span><span class="p">(</span><span class="n">blip_files</span><span class="p">)</span>
        <span class="n">blip_enc_dirs</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">blip_enc_dirs</span><span class="p">)</span>

    <span class="c1"># Read input parameters</span>
    <span class="n">realign_to_mean</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">realign_to_vol</span>
    <span class="n">subjdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">sid</span><span class="p">)</span>
    <span class="n">cachedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjdir</span><span class="p">,</span> <span class="s2">&quot;cachedir&quot;</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">erase</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">subjdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">subjdir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">cachedir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
    <span class="n">nipype_memory</span> <span class="o">=</span> <span class="n">NipypeMemory</span><span class="p">(</span><span class="n">cachedir</span><span class="p">)</span>
    <span class="n">joblib_memory</span> <span class="o">=</span> <span class="n">JoblibMemory</span><span class="p">(</span><span class="n">cachedir</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">display_outputs</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Simple function to display/store step outputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0}: {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">outputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Check input parameters</span>
    <span class="n">template_axes</span> <span class="o">=</span> <span class="n">guess_orientation</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">template_axes</span> <span class="o">!=</span> <span class="s2">&quot;RAS&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The template orientation must be &#39;RAS&#39;, &#39;{0}&#39; &quot;</span>
                         <span class="s2">&quot;found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">template_axes</span><span class="p">))</span>
    <span class="n">check_jip_install</span><span class="p">(</span><span class="n">jipdir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sliceorder</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ascending&quot;</span><span class="p">,</span> <span class="s2">&quot;descending&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Supported slice order are: ascending &amp; descending.&quot;</span><span class="p">)</span>

    <span class="c1"># Slice timing</span>
    <span class="n">fslenv</span> <span class="o">=</span> <span class="n">environment</span><span class="p">(</span><span class="n">fslconfig</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fslenv</span><span class="p">[</span><span class="s2">&quot;FSLDIR&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FSLDIR&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="n">concat_environment</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="n">fslenv</span><span class="p">)</span>
    <span class="n">st_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjdir</span><span class="p">,</span> <span class="n">STEPS</span><span class="p">[</span><span class="s2">&quot;slice_timing&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">st_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">st_dir</span><span class="p">)</span>
    <span class="n">fsl</span><span class="o">.</span><span class="n">FSLCommand</span><span class="o">.</span><span class="n">set_default_output_type</span><span class="p">(</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">)</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">nipype_memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">SliceTimer</span><span class="p">)</span>
    <span class="n">returncode</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
        <span class="n">in_file</span><span class="o">=</span><span class="n">funcfile</span><span class="p">,</span>
        <span class="n">interleaved</span><span class="o">=</span><span class="n">interleaved</span><span class="p">,</span>
        <span class="n">slice_direction</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">time_repetition</span><span class="o">=</span><span class="n">repetitiontime</span><span class="p">,</span>
        <span class="n">index_dir</span><span class="o">=</span><span class="bp">False</span> <span class="k">if</span> <span class="n">sliceorder</span><span class="o">==</span><span class="s2">&quot;ascending&quot;</span> <span class="k">else</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">out_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">st_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">funcfile</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.nii.gz&quot;</span><span class="p">))</span>
    <span class="n">st_outputs</span> <span class="o">=</span> <span class="n">returncode</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">slice_time_corrected_file</span> <span class="o">=</span> <span class="n">st_outputs</span><span class="p">[</span><span class="s2">&quot;slice_time_corrected_file&quot;</span><span class="p">]</span>
    <span class="n">display_outputs</span><span class="p">(</span>
        <span class="n">outputs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">slice_time_corrected_file</span><span class="o">=</span><span class="n">slice_time_corrected_file</span><span class="p">)</span>

    <span class="c1"># B0 inhomogeneities: topup or fugue or None + motion induced</span>
    <span class="k">if</span> <span class="n">warp</span><span class="p">:</span>
        <span class="n">warp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjdir</span><span class="p">,</span> <span class="n">STEPS</span><span class="p">[</span><span class="s2">&quot;warp&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">warp_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">warp_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">blip_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">interface</span> <span class="o">=</span> <span class="n">joblib_memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">topup</span><span class="p">)</span>
            <span class="n">fieldmap_hz_file</span><span class="p">,</span> <span class="n">unwarped_epi_file</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
                <span class="n">blip_up_file</span><span class="o">=</span><span class="n">blip_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">blip_down_file</span><span class="o">=</span><span class="n">blip_files</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">blip_up_phase_enc_dir</span><span class="o">=</span><span class="n">blip_enc_dirs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">blip_down_phase_enc_dir</span><span class="o">=</span><span class="n">blip_enc_dirs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">apply_to</span><span class="o">=</span><span class="n">slice_time_corrected_file</span><span class="p">,</span>
                <span class="n">unwarp_direction</span><span class="o">=</span><span class="n">unwarp_direction</span><span class="p">,</span>
                <span class="n">dwell_time</span><span class="o">=</span><span class="n">dwell_time</span><span class="p">,</span>
                <span class="n">outdir</span><span class="o">=</span><span class="n">warp_dir</span><span class="p">,</span>
                <span class="n">fsl_sh</span><span class="o">=</span><span class="n">fslconfig</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">phase_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">interface</span> <span class="o">=</span> <span class="n">joblib_memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">fugue</span><span class="p">)</span>
            <span class="n">magnitude_brain_mask_file</span><span class="p">,</span> <span class="n">vsm_file</span><span class="p">,</span> <span class="n">unwarped_epi_file</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
                <span class="n">epi_file</span><span class="o">=</span><span class="n">slice_time_corrected_file</span><span class="p">,</span>
                <span class="n">phase_file</span><span class="o">=</span><span class="n">phase_file</span><span class="p">,</span>
                <span class="n">magnitude_file</span><span class="o">=</span><span class="n">magnitude_file</span><span class="p">,</span>
                <span class="n">delta_te</span><span class="o">=</span><span class="n">delta_te</span><span class="p">,</span>
                <span class="n">dwell_time</span><span class="o">=</span><span class="n">dwell_time</span><span class="p">,</span>
                <span class="n">unwarp_direction</span><span class="o">=</span><span class="n">unwarp_direction</span><span class="p">,</span>
                <span class="n">manufacturer</span><span class="o">=</span><span class="n">manufacturer</span><span class="p">,</span>
                <span class="n">outdir</span><span class="o">=</span><span class="n">warp_dir</span><span class="p">,</span>
                <span class="n">fsl_sh</span><span class="o">=</span><span class="n">fslconfig</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unwarped_epi_file</span> <span class="o">=</span> <span class="n">slice_time_corrected_file</span>
        <span class="n">interface</span> <span class="o">=</span> <span class="n">joblib_memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">timeserie_to_reference</span><span class="p">)</span>
        <span class="n">b0_corrected_file</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
            <span class="n">tfile</span><span class="o">=</span><span class="n">unwarped_epi_file</span><span class="p">,</span>
            <span class="n">rindex</span><span class="o">=</span><span class="n">warp_index</span><span class="p">,</span>
            <span class="n">restrict_deformation</span><span class="o">=</span><span class="n">warp_restrict</span><span class="p">,</span>
            <span class="n">rfile</span><span class="o">=</span><span class="n">warp_file</span><span class="p">,</span>
            <span class="n">outdir</span><span class="o">=</span><span class="n">warp_dir</span><span class="p">,</span>
            <span class="n">njobs</span><span class="o">=</span><span class="n">warp_njobs</span><span class="p">,</span>
            <span class="n">clean_tmp</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b0_corrected_file</span> <span class="o">=</span> <span class="n">slice_time_corrected_file</span>
    <span class="n">display_outputs</span><span class="p">(</span>
        <span class="n">outputs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">b0_corrected_file</span><span class="o">=</span><span class="n">b0_corrected_file</span><span class="p">)</span>

    <span class="c1"># Reorient images not in RAS coordinate system and</span>
    <span class="c1"># reorient images to match the orientation of the standard MNI152 template.</span>
    <span class="n">reorient_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjdir</span><span class="p">,</span> <span class="n">STEPS</span><span class="p">[</span><span class="s2">&quot;reorient&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">reorient_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">reorient_dir</span><span class="p">)</span>
    <span class="n">reoriented_funcfile</span> <span class="o">=</span> <span class="n">b0_corrected_file</span>
    <span class="n">reoriented_anatfile</span> <span class="o">=</span> <span class="n">anatfile</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">joblib_memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">reorient_image</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">funcorient</span> <span class="o">!=</span> <span class="s2">&quot;RAS&quot;</span><span class="p">:</span>
        <span class="n">reoriented_funcfile</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
            <span class="n">b0_corrected_file</span><span class="p">,</span>
            <span class="n">axes</span><span class="o">=</span><span class="n">funcorient</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
            <span class="n">output_directory</span><span class="o">=</span><span class="n">reorient_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">anatorient</span> <span class="o">!=</span> <span class="s2">&quot;RAS&quot;</span><span class="p">:</span>
        <span class="n">reoriented_anatfile</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
            <span class="n">anatfile</span><span class="p">,</span>
            <span class="n">axes</span><span class="o">=</span><span class="n">anatorient</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
            <span class="n">output_directory</span><span class="o">=</span><span class="n">reorient_dir</span><span class="p">)</span>
    <span class="n">standard_funcfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">reorient_dir</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">reoriented_funcfile</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">standard_anatfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">reorient_dir</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">reoriented_anatfile</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">joblib_memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">fslreorient2std</span><span class="p">)</span>
    <span class="n">standard_funcfile</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
        <span class="n">reoriented_funcfile</span><span class="p">,</span>
        <span class="n">standard_funcfile</span><span class="p">,</span>
        <span class="n">fslconfig</span><span class="o">=</span><span class="n">fslconfig</span><span class="p">)</span>
    <span class="n">standard_anatfile</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
        <span class="n">reoriented_anatfile</span><span class="p">,</span>
        <span class="n">standard_anatfile</span><span class="p">,</span>
        <span class="n">fslconfig</span><span class="o">=</span><span class="n">fslconfig</span><span class="p">)</span>
    <span class="n">display_outputs</span><span class="p">(</span>
        <span class="n">outputs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">standard_funcfile</span><span class="o">=</span><span class="n">standard_funcfile</span><span class="p">,</span>
        <span class="n">standard_anatfile</span><span class="o">=</span><span class="n">standard_anatfile</span><span class="p">)</span>

    <span class="c1"># Downsample template</span>
    <span class="k">if</span> <span class="n">resample</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">resample_image</span><span class="p">(</span>
            <span class="n">source_file</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
            <span class="n">target_file</span><span class="o">=</span><span class="n">standard_anatfile</span><span class="p">,</span>
            <span class="n">out_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjdir</span><span class="p">,</span> <span class="s2">&quot;template.nii.gz&quot;</span><span class="p">),</span>
            <span class="n">fslconfig</span><span class="o">=</span><span class="n">fslconfig</span><span class="p">)</span>

    <span class="c1"># Realign</span>
    <span class="n">realign_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjdir</span><span class="p">,</span> <span class="n">STEPS</span><span class="p">[</span><span class="s2">&quot;realign&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">realign_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">realign_dir</span><span class="p">)</span>
    <span class="n">realign_func_rootfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">realign_dir</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">standard_funcfile</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">joblib_memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">mcflirt</span><span class="p">)</span>
    <span class="n">realign_funcfile</span><span class="p">,</span> <span class="n">realign_func_meanfile</span><span class="p">,</span> <span class="n">realign_func_parfile</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
        <span class="n">in_file</span><span class="o">=</span><span class="n">standard_funcfile</span><span class="p">,</span>
        <span class="n">out_fileroot</span><span class="o">=</span><span class="n">realign_func_rootfile</span><span class="p">,</span>
        <span class="n">cost</span><span class="o">=</span><span class="s2">&quot;normcorr&quot;</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
        <span class="n">dof</span><span class="o">=</span><span class="n">realign_dof</span><span class="p">,</span>
        <span class="n">refvol</span><span class="o">=</span><span class="n">warp_index</span><span class="p">,</span>
        <span class="n">reffile</span><span class="o">=</span><span class="n">warp_file</span><span class="p">,</span>
        <span class="n">reg_to_mean</span><span class="o">=</span><span class="n">realign_to_mean</span><span class="p">,</span>
        <span class="n">mats</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">plots</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="n">shfile</span><span class="o">=</span><span class="n">fslconfig</span><span class="p">)</span>
    <span class="n">display_outputs</span><span class="p">(</span>
        <span class="n">outputs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">realign_funcfile</span><span class="o">=</span><span class="n">realign_funcfile</span><span class="p">,</span>
        <span class="n">realign_func_meanfile</span><span class="o">=</span><span class="n">realign_func_meanfile</span><span class="p">)</span>

    <span class="c1"># Early stop detected</span>
    <span class="k">if</span> <span class="n">recon1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;[warn] User requested a processing early stop. Remove the &#39;recon1&#39; &quot;</span>
              <span class="s2">&quot;option to resume.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>

    <span class="c1"># Normalization.</span>
    <span class="n">normalization_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjdir</span><span class="p">,</span> <span class="n">STEPS</span><span class="p">[</span><span class="s2">&quot;normalization&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">normalization_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">normalization_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">normalization_trf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">normalization_trf</span><span class="p">,</span> <span class="n">normalization_dir</span><span class="p">)</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">joblib_memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">jip_align</span><span class="p">)</span>
    <span class="p">(</span><span class="n">register_anatfile</span><span class="p">,</span> <span class="n">register_anat_maskfile</span><span class="p">,</span>
     <span class="n">native_anat_maskfile</span><span class="p">,</span> <span class="n">align_normfile</span><span class="p">)</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
        <span class="n">source_file</span><span class="o">=</span><span class="n">standard_anatfile</span><span class="p">,</span>
        <span class="n">target_file</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
        <span class="n">outdir</span><span class="o">=</span><span class="n">normalization_dir</span><span class="p">,</span>
        <span class="n">jipdir</span><span class="o">=</span><span class="n">jipdir</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">auto</span><span class="o">=</span><span class="n">auto</span><span class="p">,</span>
        <span class="n">non_linear</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">fslconfig</span><span class="o">=</span><span class="n">fslconfig</span><span class="p">)</span>
    <span class="n">display_outputs</span><span class="p">(</span>
        <span class="n">outputs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">register_anatfile</span><span class="o">=</span><span class="n">register_anatfile</span><span class="p">,</span>
        <span class="n">register_anat_maskfile</span><span class="o">=</span><span class="n">register_anat_maskfile</span><span class="p">,</span>
        <span class="n">native_anat_maskfile</span><span class="o">=</span><span class="n">native_anat_maskfile</span><span class="p">,</span> <span class="n">align_normfile</span><span class="o">=</span><span class="n">align_normfile</span><span class="p">)</span>

    <span class="c1"># Tissues segmentation and spatial intensity variations correction.</span>
    <span class="n">inhomogeneities_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjdir</span><span class="p">,</span> <span class="n">STEPS</span><span class="p">[</span><span class="s2">&quot;inhomogeneities&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">inhomogeneities_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">inhomogeneities_dir</span><span class="p">)</span>
    <span class="n">biascorrected_anatfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">inhomogeneities_dir</span><span class="p">,</span> <span class="s2">&quot;n4_&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">native_anat_maskfile</span><span class="p">))</span>
    <span class="n">bias_anatfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">inhomogeneities_dir</span><span class="p">,</span> <span class="s2">&quot;n4field_&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">native_anat_maskfile</span><span class="p">))</span>
    <span class="n">n4</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">N4BiasFieldCorrection</span><span class="p">()</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">nipype_memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">ants</span><span class="o">.</span><span class="n">N4BiasFieldCorrection</span><span class="p">)</span>
    <span class="n">returncode</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
        <span class="n">dimension</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">input_image</span><span class="o">=</span><span class="n">native_anat_maskfile</span><span class="p">,</span>
        <span class="n">bspline_fitting_distance</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">shrink_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">n_iterations</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">30</span><span class="p">],</span>
        <span class="n">convergence_threshold</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
        <span class="n">output_image</span><span class="o">=</span><span class="n">biascorrected_anatfile</span><span class="p">,</span>
        <span class="n">bias_image</span><span class="o">=</span><span class="n">bias_anatfile</span><span class="p">)</span>
    <span class="n">n4_outputs</span> <span class="o">=</span> <span class="n">returncode</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">display_outputs</span><span class="p">(</span>
        <span class="n">outputs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">bias_anatfile</span><span class="o">=</span><span class="n">bias_anatfile</span><span class="p">,</span>
        <span class="n">biascorrected_anatfile</span><span class="o">=</span><span class="n">biascorrected_anatfile</span><span class="p">)</span>

    <span class="c1"># Coregistration.</span>
    <span class="n">coregistration_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjdir</span><span class="p">,</span> <span class="n">STEPS</span><span class="p">[</span><span class="s2">&quot;coregistration&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">coregistration_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">coregistration_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">coregistration_trf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">coregistration_trf</span><span class="p">,</span> <span class="n">coregistration_dir</span><span class="p">)</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">joblib_memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">jip_align</span><span class="p">)</span>
    <span class="p">(</span><span class="n">register_func_meanfile</span><span class="p">,</span> <span class="n">register_func_mean_maskfile</span><span class="p">,</span>
     <span class="n">native_func_mean_maskfile</span><span class="p">,</span> <span class="n">align_coregfile</span><span class="p">)</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
        <span class="n">source_file</span><span class="o">=</span><span class="n">realign_func_meanfile</span><span class="p">,</span>
        <span class="n">target_file</span><span class="o">=</span><span class="n">biascorrected_anatfile</span><span class="p">,</span>
        <span class="n">outdir</span><span class="o">=</span><span class="n">coregistration_dir</span><span class="p">,</span>
        <span class="n">jipdir</span><span class="o">=</span><span class="n">jipdir</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">auto</span><span class="o">=</span><span class="n">auto</span><span class="p">,</span>
        <span class="n">non_linear</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">fslconfig</span><span class="o">=</span><span class="n">fslconfig</span><span class="p">)</span>
    <span class="n">display_outputs</span><span class="p">(</span>
        <span class="n">outputs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">register_func_meanfile</span><span class="o">=</span><span class="n">register_func_meanfile</span><span class="p">,</span>
        <span class="n">register_func_mean_maskfile</span><span class="o">=</span><span class="n">register_func_mean_maskfile</span><span class="p">,</span>
        <span class="n">native_func_mean_maskfile</span><span class="o">=</span><span class="n">native_func_mean_maskfile</span><span class="p">,</span>
        <span class="n">align_coregfile</span><span class="o">=</span><span class="n">align_coregfile</span><span class="p">)</span>

    <span class="c1"># Early stop detected</span>
    <span class="k">if</span> <span class="n">recon2</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;[warn] User requested a processing early stop. Remove the &#39;recon2&#39; &quot;</span>
              <span class="s2">&quot;option to resume.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>

    <span class="c1"># Wrap functional: resample the functional serie and mask the registered serie.</span>
    <span class="n">wrap_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjdir</span><span class="p">,</span> <span class="n">STEPS</span><span class="p">[</span><span class="s2">&quot;wrap&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">wrap_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">wrap_dir</span><span class="p">)</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">joblib_memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">apply_jip_align</span><span class="p">)</span>
    <span class="n">deformed_files</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
        <span class="n">apply_to_files</span><span class="o">=</span><span class="p">[</span><span class="n">realign_funcfile</span><span class="p">],</span>
        <span class="n">align_with</span><span class="o">=</span><span class="p">[</span><span class="n">align_coregfile</span><span class="p">,</span> <span class="n">align_normfile</span><span class="p">],</span>
        <span class="n">outdir</span><span class="o">=</span><span class="n">wrap_dir</span><span class="p">,</span>
        <span class="n">jipdir</span><span class="o">=</span><span class="n">jipdir</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="n">apply_inv</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">register_funcfile</span> <span class="o">=</span> <span class="n">deformed_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">register_func_mask_fileroot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">wrap_dir</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">register_funcfile</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">joblib_memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">apply_mask</span><span class="p">)</span>
    <span class="n">register_func_maskfile</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
        <span class="n">input_file</span><span class="o">=</span><span class="n">register_funcfile</span><span class="p">,</span>
        <span class="n">output_fileroot</span><span class="o">=</span><span class="n">register_func_mask_fileroot</span><span class="p">,</span>
        <span class="n">mask_file</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
        <span class="n">fslconfig</span><span class="o">=</span><span class="n">fslconfig</span><span class="p">)</span>
    <span class="n">display_outputs</span><span class="p">(</span>
        <span class="n">outputs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">register_funcfile</span><span class="o">=</span><span class="n">register_funcfile</span><span class="p">,</span>
        <span class="n">register_func_maskfile</span><span class="o">=</span><span class="n">register_func_maskfile</span><span class="p">)</span>

    <span class="c1"># Smooth the functional serie.</span>
    <span class="n">smooth_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjdir</span><span class="p">,</span> <span class="n">STEPS</span><span class="p">[</span><span class="s2">&quot;smooth&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">smooth_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">smooth_dir</span><span class="p">)</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">nipype_memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">fsl</span><span class="o">.</span><span class="n">Smooth</span><span class="p">)</span>
    <span class="n">returncode</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
        <span class="n">in_file</span><span class="o">=</span><span class="n">register_func_maskfile</span><span class="p">,</span>
        <span class="n">fwhm</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
        <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;NIFTI&quot;</span><span class="p">,</span>
        <span class="n">smoothed_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">smooth_dir</span><span class="p">,</span>
            <span class="s2">&quot;smooth_&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">register_func_maskfile</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
            <span class="s2">&quot;.nii&quot;</span><span class="p">))</span>
    <span class="n">smooth_outputs</span> <span class="o">=</span> <span class="n">returncode</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">smoothed_file</span> <span class="o">=</span> <span class="n">smooth_outputs</span><span class="p">[</span><span class="s2">&quot;smoothed_file&quot;</span><span class="p">]</span>
    <span class="n">display_outputs</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">smoothed_file</span><span class="o">=</span><span class="n">smoothed_file</span><span class="p">)</span>

    <span class="c1"># Copy the results to the root directory: use Nifti format.</span>
    <span class="n">nibabel</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">smoothed_file</span><span class="p">)</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjdir</span><span class="p">,</span> <span class="s2">&quot;sMNI.nii&quot;</span><span class="p">))</span>
    <span class="n">nibabel</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">register_func_maskfile</span><span class="p">)</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjdir</span><span class="p">,</span> <span class="s2">&quot;MNI.nii&quot;</span><span class="p">))</span>
    <span class="n">nibabel</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">register_anat_maskfile</span><span class="p">)</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjdir</span><span class="p">,</span> <span class="s2">&quot;anat.nii&quot;</span><span class="p">))</span>

    <span class="c1"># Compute some snaps assessing the different processing steps.</span>
    <span class="n">snapdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjdir</span><span class="p">,</span> <span class="n">STEPS</span><span class="p">[</span><span class="s2">&quot;snaps&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">snapdir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">snapdir</span><span class="p">)</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">joblib_memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">triplanar</span><span class="p">)</span>
    <span class="c1"># &gt; generate coregistration plot</span>
    <span class="n">coregister_fileroot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">snapdir</span><span class="p">,</span> <span class="s2">&quot;coregister&quot;</span><span class="p">)</span>
    <span class="n">coregister_file</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
        <span class="n">input_file</span><span class="o">=</span><span class="n">register_func_meanfile</span><span class="p">,</span>
        <span class="n">output_fileroot</span><span class="o">=</span><span class="n">coregister_fileroot</span><span class="p">,</span>
        <span class="n">overlays</span><span class="o">=</span><span class="p">[</span><span class="n">standard_anatfile</span><span class="p">],</span>
        <span class="n">overlays_colors</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">contours</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">edges</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">overlay_opacities</span><span class="o">=</span><span class="p">[</span><span class="mf">0.7</span><span class="p">],</span>
        <span class="n">resolution</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="c1"># &gt; generate normalization plot</span>
    <span class="n">normalize_fileroot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">snapdir</span><span class="p">,</span> <span class="s2">&quot;normalization&quot;</span><span class="p">)</span>
    <span class="n">normalize_file</span> <span class="o">=</span> <span class="n">interface</span><span class="p">(</span>
        <span class="n">input_file</span><span class="o">=</span><span class="n">register_anatfile</span><span class="p">,</span>
        <span class="n">output_fileroot</span><span class="o">=</span><span class="n">normalize_fileroot</span><span class="p">,</span>
        <span class="n">overlays</span><span class="o">=</span><span class="p">[</span><span class="n">template</span><span class="p">],</span>
        <span class="n">overlays_colors</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">contours</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">edges</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">overlay_opacities</span><span class="o">=</span><span class="p">[</span><span class="mf">0.7</span><span class="p">],</span>
        <span class="n">resolution</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="c1"># &gt; generate a motion parameter plot</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">joblib_memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">plot_fsl_motion_parameters</span><span class="p">)</span>
    <span class="n">realign_motion_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">snapdir</span><span class="p">,</span> <span class="s2">&quot;realign_motion_parameters.png&quot;</span><span class="p">)</span>
    <span class="n">interface</span><span class="p">(</span><span class="n">realign_func_parfile</span><span class="p">,</span> <span class="n">realign_motion_file</span><span class="p">)</span>
    <span class="n">display_outputs</span><span class="p">(</span>
        <span class="n">outputs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">normalize_file</span><span class="o">=</span><span class="n">normalize_file</span><span class="p">,</span>
        <span class="n">realign_motion_file</span><span class="o">=</span><span class="n">realign_motion_file</span><span class="p">,</span> <span class="n">coregister_file</span><span class="o">=</span><span class="n">coregister_file</span><span class="p">)</span>

    <span class="c1"># Generate a QC reporting</span>
    <span class="n">reportdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subjdir</span><span class="p">,</span> <span class="n">STEPS</span><span class="p">[</span><span class="s2">&quot;report&quot;</span><span class="p">])</span>
    <span class="n">reportfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reportdir</span><span class="p">,</span> <span class="s2">&quot;QC_preproc_{0}.pdf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sid</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">reportdir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">reportdir</span><span class="p">)</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">joblib_memory</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">generate_pdf</span><span class="p">)</span>
    <span class="n">tic</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">date</span> <span class="o">=</span> <span class="s2">&quot;{0}-{1}-{2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tic</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">tic</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">tic</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    <span class="n">interface</span><span class="p">(</span>
        <span class="n">datapath</span><span class="o">=</span><span class="n">snapdir</span><span class="p">,</span>
        <span class="n">struct_file</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">pypreclin</span><span class="o">.</span><span class="n">__file__</span><span class="p">)),</span> <span class="s2">&quot;utils&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resources&quot;</span><span class="p">,</span> <span class="s2">&quot;pypreclin_qcpreproc.json&quot;</span><span class="p">),</span>
        <span class="n">author</span><span class="o">=</span><span class="s2">&quot;NeuroSpin&quot;</span><span class="p">,</span>
        <span class="n">client</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="n">poweredby</span><span class="o">=</span><span class="s2">&quot;FSL-SPM-Nipype-JIP&quot;</span><span class="p">,</span>
        <span class="n">project</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="n">timepoint</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="n">subject</span><span class="o">=</span><span class="n">sid</span><span class="p">,</span>
        <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;fMRI Preprocessing QC Reporting&quot;</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">reportfile</span><span class="p">,</span>
        <span class="n">pagesize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">left_margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">right_margin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">top_margin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">bottom_margin</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">show_boundary</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">display_outputs</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">reportfile</span><span class="o">=</span><span class="n">reportfile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outputs</span></div>


<div class="viewcode-block" id="preproc_multi"><a class="viewcode-back" href="../../../generated/pypreclin.workflow.preproc_fmri.html#pypreclin.workflow.preproc_fmri.preproc_multi">[docs]</a><span class="k">def</span> <span class="nf">preproc_multi</span><span class="p">(</span>
        <span class="n">bidsdir</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">jipdir</span><span class="p">,</span> <span class="n">fslconfig</span><span class="p">,</span> <span class="n">auto</span><span class="p">,</span> <span class="n">resample</span><span class="p">,</span> <span class="n">anatorient</span><span class="o">=</span><span class="s2">&quot;RAS&quot;</span><span class="p">,</span>
        <span class="n">funcorient</span><span class="o">=</span><span class="s2">&quot;RAS&quot;</span><span class="p">,</span> <span class="n">njobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">simage</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">shome</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sbinds</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Perform the FMRI preprocessing on a BIDS organized directory in</span>
<span class="sd">    parallel (without FUGUE or TOPUP).</span>
<span class="sd">    This function can be called with a singularity image that contains all the</span>
<span class="sd">    required software.</span>

<span class="sd">    If a &#39;jip_trf&#39; directory is available in the session directory, the code</span>
<span class="sd">    will use the available JIP transformation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    </span>
<span class="sd">    bidsdir: str</span>
<span class="sd">        the BIDS organized directory.</span>
<span class="sd">    template: str</span>
<span class="sd">        the path to the template in RAS coordiante system.</span>
<span class="sd">    jipdir: str</span>
<span class="sd">        the jip software binary path.</span>
<span class="sd">    fslconfig: str</span>
<span class="sd">        the FSL configuration script.</span>
<span class="sd">    auto: bool</span>
<span class="sd">        control the JIP window with the script.</span>
<span class="sd">    resample: bool</span>
<span class="sd">        if set resample the input template to fit the anatomical image.</span>
<span class="sd">    anatorient: str, default &quot;RAS&quot;</span>
<span class="sd">        the input anatomical image orientation.</span>
<span class="sd">    funcorient: str, default &quot;RAS&quot;</span>
<span class="sd">        the input functional image orientation.</span>
<span class="sd">    njobs: int, default 1</span>
<span class="sd">        the number of parallel jobs.</span>
<span class="sd">    simage: simg, default None</span>
<span class="sd">        a singularity image.</span>
<span class="sd">    shome: str, default None</span>
<span class="sd">        a home directory for the singularity image.</span>
<span class="sd">    sbinds: str, default None</span>
<span class="sd">        shared directories for the singularity image.</span>
<span class="sd">    verbose: int, default 0</span>
<span class="sd">        control the verbosity level.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: remove when all controls available in pypipe</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">auto</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">auto</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">auto</span><span class="p">)</span>
        <span class="n">resample</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">resample</span><span class="p">)</span>
        <span class="n">sbinds</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">sbinds</span><span class="p">)</span>

    <span class="c1"># Parse the BIDS directory</span>
    <span class="n">desc_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bidsdir</span><span class="p">,</span> <span class="s2">&quot;dataset_description.json&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">desc_file</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Expect &#39;{0}&#39; in a BIDS organized directory.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">desc_file</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">desc_file</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">desc</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Processing dataset &#39;{0}&#39;...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="n">funcfiles</span><span class="p">,</span> <span class="n">anatfiles</span><span class="p">,</span> <span class="n">subjects</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">trs</span><span class="p">,</span> <span class="n">encdirs</span><span class="p">,</span> <span class="n">normfiles</span><span class="p">,</span> <span class="n">coregfiles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>
    <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bidsdir</span><span class="p">,</span> <span class="s2">&quot;derivatives&quot;</span><span class="p">,</span> <span class="s2">&quot;preproc&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sesdir</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bidsdir</span><span class="p">,</span> <span class="s2">&quot;sub-*&quot;</span><span class="p">,</span> <span class="s2">&quot;ses-*&quot;</span><span class="p">)):</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">sesdir</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
        <span class="n">sid</span><span class="p">,</span> <span class="n">ses</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">_anatfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sesdir</span><span class="p">,</span> <span class="s2">&quot;anat&quot;</span><span class="p">,</span> <span class="s2">&quot;sub-*T1w.nii.gz&quot;</span><span class="p">))</span>
        <span class="n">_funcfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sesdir</span><span class="p">,</span> <span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="s2">&quot;sub-*bold.nii.gz&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_anatfiles</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Skip session &#39;{0}&#39;: no valid anat.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sesdir</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_funcfiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Skip session &#39;{0}&#39;: no valid func.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sesdir</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="n">descs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">_funcfiles</span><span class="p">:</span>
            <span class="n">runs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.*_(run-[0-9]*)_.*&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Skip path &#39;{0}&#39;: not valid name.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">sesdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">ses</span><span class="p">)</span>
            <span class="n">rundir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sesdir</span><span class="p">,</span> <span class="n">runs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">rundir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span>
            <span class="n">desc_file</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nii.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">desc_file</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">desc_file</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
                <span class="n">_desc</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_desc</span><span class="p">[</span><span class="s2">&quot;PhaseEncodingDirection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">):</span>
                <span class="n">warp_restrict</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">_desc</span><span class="p">[</span><span class="s2">&quot;PhaseEncodingDirection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;j&quot;</span><span class="p">):</span>
                <span class="n">warp_restrict</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">_desc</span><span class="p">[</span><span class="s2">&quot;PhaseEncodingDirection&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">):</span>
                <span class="n">warp_restrict</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Unknown encode phase direction : {0}...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">_desc</span><span class="p">[</span><span class="s2">&quot;PhaseEncodingDirection&quot;</span><span class="p">]))</span>
            <span class="n">jip_normalization</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">sesdir</span><span class="p">,</span> <span class="s2">&quot;jip_trf&quot;</span><span class="p">,</span> <span class="s2">&quot;Normalization&quot;</span><span class="p">,</span> <span class="s2">&quot;align.com&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">jip_normalization</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;No JIP normalization align.com file found &quot;</span>
                          <span class="s2">&quot;in {0}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sesdir</span><span class="p">))</span>
                <span class="n">jip_normalization</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">jip_coregistration</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">sesdir</span><span class="p">,</span> <span class="s2">&quot;jip_trf&quot;</span><span class="p">,</span> <span class="s2">&quot;Coregistration&quot;</span><span class="p">,</span> <span class="s2">&quot;align.com&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">jip_coregistration</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;No JIP coregistration align.com file found &quot;</span>
                          <span class="s2">&quot;in {0}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sesdir</span><span class="p">))</span>
                <span class="n">jip_coregistration</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;tr&quot;</span><span class="p">:</span> <span class="n">_desc</span><span class="p">[</span><span class="s2">&quot;RepetitionTime&quot;</span><span class="p">],</span>
                <span class="s2">&quot;warp_restrict&quot;</span><span class="p">:</span> <span class="n">warp_restrict</span><span class="p">,</span>
                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">rundir</span><span class="p">}</span>
            <span class="n">descs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
            <span class="n">funcfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">anatfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_anatfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">subjects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rundir</span><span class="p">)</span>
            <span class="n">trs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_desc</span><span class="p">[</span><span class="s2">&quot;RepetitionTime&quot;</span><span class="p">])</span>
            <span class="n">encdirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">warp_restrict</span><span class="p">)</span>
            <span class="n">normfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jip_normalization</span><span class="p">)</span>
            <span class="n">coregfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jip_coregistration</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_funcfiles</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">descs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Skip session &#39;{0}&#39;: no valid desc.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sesdir</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">sid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
            <span class="n">dataset</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dataset</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">sid</span><span class="p">][</span><span class="n">ses</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;anat&quot;</span><span class="p">:</span> <span class="n">_anatfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;func&quot;</span><span class="p">:</span> <span class="n">_funcfiles</span><span class="p">,</span>
            <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="n">descs</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

    <span class="c1"># Preprare inputs</span>
    <span class="n">expected_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">expected_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;no data to process.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">((</span><span class="s2">&quot;outputs&quot;</span><span class="p">,</span> <span class="n">outputs</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;funcfiles&quot;</span><span class="p">,</span> <span class="n">funcfiles</span><span class="p">),</span>
                       <span class="p">(</span><span class="s2">&quot;anatfiles&quot;</span><span class="p">,</span> <span class="n">anatfiles</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;subjects&quot;</span><span class="p">,</span> <span class="n">subjects</span><span class="p">),</span>
                       <span class="p">(</span><span class="s2">&quot;trs&quot;</span><span class="p">,</span> <span class="n">trs</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;encdirs&quot;</span><span class="p">,</span> <span class="n">encdirs</span><span class="p">),</span>
                       <span class="p">(</span><span class="s2">&quot;normfiles&quot;</span><span class="p">,</span> <span class="n">normfiles</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;coregfiles&quot;</span><span class="p">,</span> <span class="n">coregfiles</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;[{0}] {1} : {2} ... {3}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">!=</span> <span class="n">expected_size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;BIDS dataset not aligned.&quot;</span><span class="p">)</span>

    <span class="c1"># Run preproc</span>
    <span class="n">scriptdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">pypreclin</span><span class="o">.</span><span class="n">__file__</span><span class="p">),</span> <span class="s2">&quot;scripts&quot;</span><span class="p">)</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scriptdir</span><span class="p">,</span> <span class="s2">&quot;pypreclin_preproc_fmri&quot;</span><span class="p">)</span>
    <span class="n">python_cmd</span> <span class="o">=</span> <span class="s2">&quot;python3&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script</span><span class="p">):</span>
        <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;pypreclin_preproc_fmri&quot;</span>
        <span class="n">python_cmd</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">simage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;singularity run --home {0} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">shome</span> <span class="ow">or</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">())</span>
        <span class="n">sbinds</span> <span class="o">=</span> <span class="n">sbinds</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">sbinds</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;--bind {0} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">+=</span> <span class="n">simage</span>
        <span class="n">python_cmd</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">logdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bidsdir</span><span class="p">,</span> <span class="s2">&quot;derivatives&quot;</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">logdir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">logdir</span><span class="p">)</span>
    <span class="n">logfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">logdir</span><span class="p">,</span> <span class="s2">&quot;pypreclin_{0}.log&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()))</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">exitcodes</span> <span class="o">=</span> <span class="n">hopla</span><span class="p">(</span>
        <span class="n">script</span><span class="p">,</span>
        <span class="n">hopla_iterative_kwargs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;WR&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">],</span>
        <span class="n">f</span><span class="o">=</span><span class="n">funcfiles</span><span class="p">,</span>
        <span class="n">a</span><span class="o">=</span><span class="n">anatfiles</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="n">subjects</span><span class="p">,</span>
        <span class="n">o</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
        <span class="n">r</span><span class="o">=</span><span class="n">trs</span><span class="p">,</span>
        <span class="n">t</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
        <span class="n">j</span><span class="o">=</span><span class="n">jipdir</span><span class="p">,</span>
        <span class="n">resample</span><span class="o">=</span><span class="n">resample</span><span class="p">,</span>
        <span class="n">W</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">WN</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">WR</span><span class="o">=</span><span class="n">encdirs</span><span class="p">,</span>
        <span class="n">NA</span><span class="o">=</span><span class="n">anatorient</span><span class="p">,</span>
        <span class="n">NF</span><span class="o">=</span><span class="n">funcorient</span><span class="p">,</span>
        <span class="n">C</span><span class="o">=</span><span class="n">fslconfig</span><span class="p">,</span>
        <span class="n">N</span><span class="o">=</span><span class="n">normfiles</span><span class="p">,</span>
        <span class="n">M</span><span class="o">=</span><span class="n">coregfiles</span><span class="p">,</span>
        <span class="n">A</span><span class="o">=</span><span class="n">auto</span><span class="p">,</span>
        <span class="n">hopla_python_cmd</span><span class="o">=</span><span class="n">python_cmd</span><span class="p">,</span>
        <span class="n">hopla_use_subprocess</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">hopla_verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">hopla_cpus</span><span class="o">=</span><span class="n">njobs</span><span class="p">,</span>
        <span class="n">hopla_logfile</span><span class="o">=</span><span class="n">logfile</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;logfile&quot;</span><span class="p">:</span> <span class="n">logfile</span><span class="p">}</span></div>
    
</pre></div>

          </div>
        </div>
      </div>

    <div class="clearer">
    </div>
  </div>
  
</div>

<div class="footer">
    &copy; 2019, 
Antoine Grigis &lt;antoine.grigis@cea.fr&gt;
Jordy Tasserie &lt;jordy.tasserie@cea.fr&gt;
Bechir Jarraya &lt;bechir.jarraya@cea.fr&gt;
 &lt;antoine.grigis@cea.fr&gt;.
</div>
  </body>
</html>